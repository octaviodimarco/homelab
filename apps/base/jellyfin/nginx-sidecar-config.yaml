apiVersion: v1
kind: ConfigMap
metadata:
  name: jellyfin-nginx-config
  namespace: jellyfin
data:
  nginx.conf: |
    worker_processes auto;
    error_log stderr warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /usr/local/openresty/nginx/conf/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /dev/stdout main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Disable buffering for streaming
        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 0;

        # Timeouts for streaming
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        server {
            listen 0.0.0.0:8097;
            server_name _;

            # Proxy all requests to Jellyfin on localhost:8096 (default port)
            location / {
                proxy_pass http://127.0.0.1:8096;
                proxy_http_version 1.1;
                
                # Preserve original headers
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;

                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Disable buffering
                proxy_buffering off;
                proxy_request_buffering off;
            }

            # Internal location for proxying to Jellyfin (used by subrequests)
            location = /_internal_jellyfin_proxy {
                internal;
                proxy_pass http://127.0.0.1:8096/Users/AuthenticateByName;
                proxy_http_version 1.1;
                
                # Preserve original headers
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;

                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Disable buffering
                proxy_buffering off;
                proxy_request_buffering off;
            }

            # Intercept authentication requests to inject App parameter
            location = /Users/AuthenticateByName {
                # Disable request buffering to allow body modification
                proxy_request_buffering off;
                
                # Use content phase to modify body and make subrequest
                content_by_lua_block {
                    local body_to_send = nil
                    
                    if ngx.var.request_method == "POST" then
                        ngx.req.read_body()
                        local body = ngx.req.get_body_data()
                        
                        if body then
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] Original body: " .. body)
                            local cjson = require "cjson"
                            local ok, json = pcall(cjson.decode, body)
                            
                            if ok and json then
                                ngx.log(ngx.ERR, "[JELLYFIN-FIX] JSON parsed, App=" .. tostring(json.App) .. ", Username=" .. tostring(json.Username))
                                -- Inject App parameter if missing or empty
                                if not json.App or json.App == "" then
                                    json.App = "Apple TV"
                                    body_to_send = cjson.encode(json)
                                    ngx.log(ngx.ERR, "[JELLYFIN-FIX] Injected App=Apple TV, new body: " .. body_to_send)
                                else
                                    body_to_send = body
                                end
                            else
                                ngx.log(ngx.ERR, "[JELLYFIN-FIX] Failed to parse JSON, using original body")
                                body_to_send = body
                            end
                        else
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] Body is nil or empty")
                        end
                    end
                    
                    -- Make subrequest to internal proxy location
                    local method = ngx.HTTP_GET
                    if ngx.var.request_method == "POST" then
                        method = ngx.HTTP_POST
                    elseif ngx.var.request_method == "PUT" then
                        method = ngx.HTTP_PUT
                    elseif ngx.var.request_method == "DELETE" then
                        method = ngx.HTTP_DELETE
                    end
                    
                    local res = ngx.location.capture("/_internal_jellyfin_proxy", {
                        method = method,
                        body = body_to_send or ngx.req.get_body_data(),
                        always_forward_body = true,
                        copy_all_vars = true,
                    })
                    
                    -- Forward response
                    ngx.status = res.status
                    for k, v in pairs(res.header) do
                        if k ~= "Content-Length" then
                            ngx.header[k] = v
                        end
                    end
                    if res.body then
                        ngx.header["Content-Length"] = string.len(res.body)
                        ngx.say(res.body)
                    end
                }
            }
        }
    }

