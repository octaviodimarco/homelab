apiVersion: v1
kind: ConfigMap
metadata:
  name: jellyfin-nginx-config
  namespace: jellyfin
data:
  nginx.conf: |
    worker_processes auto;
    error_log stderr warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /usr/local/openresty/nginx/conf/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /dev/stdout main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Disable buffering for streaming
        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 0;

        # Timeouts for streaming
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        server {
            listen 0.0.0.0:8097;
            server_name _;

            # Proxy all requests to Jellyfin on localhost:8096 (default port)
            location / {
                proxy_pass http://127.0.0.1:8096;
                proxy_http_version 1.1;
                
                # Preserve original headers
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;

                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Disable buffering
                proxy_buffering off;
                proxy_request_buffering off;
            }

            # Intercept authentication requests to inject App parameter
            location = /Users/AuthenticateByName {
                # Disable request buffering to allow body modification
                proxy_request_buffering off;
                
                # Use rewrite phase to modify body before proxying
                rewrite_by_lua_block {
                    if ngx.var.request_method == "POST" then
                        ngx.req.read_body()
                        local body = ngx.req.get_body_data()
                        
                        if body then
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] Original body: " .. body)
                            local cjson = require "cjson"
                            local ok, json = pcall(cjson.decode, body)
                            
                            if ok and json then
                                ngx.log(ngx.ERR, "[JELLYFIN-FIX] JSON parsed, App=" .. tostring(json.App))
                                -- Inject App parameter if missing or empty
                                if not json.App or json.App == "" then
                                    json.App = "Apple TV"
                                    local new_body = cjson.encode(json)
                                    -- Set the modified body directly
                                    ngx.req.set_body_data(new_body)
                                    ngx.req.set_header("Content-Length", string.len(new_body))
                                    ngx.log(ngx.ERR, "[JELLYFIN-FIX] Injected App=Apple TV, new body: " .. new_body)
                                end
                            else
                                ngx.log(ngx.ERR, "[JELLYFIN-FIX] Failed to parse JSON: " .. tostring(json))
                            end
                        else
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] Body is nil or empty")
                        end
                    end
                }
                
                proxy_pass http://127.0.0.1:8096;
                proxy_http_version 1.1;
                
                # Preserve original headers
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;

                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Disable buffering
                proxy_buffering off;
            }
        }
    }

