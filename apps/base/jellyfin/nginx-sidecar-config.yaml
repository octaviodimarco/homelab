apiVersion: v1
kind: ConfigMap
metadata:
  name: jellyfin-nginx-config
  namespace: jellyfin
data:
  nginx.conf: |
    worker_processes auto;
    error_log stderr warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /usr/local/openresty/nginx/conf/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /dev/stdout main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Disable buffering for streaming
        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 0;

        # Timeouts for streaming
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        server {
            listen 0.0.0.0:8097;
            server_name _;

            # Proxy all requests to Jellyfin on localhost:8096 (default port)
            location / {
                proxy_pass http://127.0.0.1:8096;
                proxy_http_version 1.1;
                
                # Preserve original headers
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;

                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Disable buffering
                proxy_buffering off;
                proxy_request_buffering off;
            }

            # Intercept authentication requests to inject App parameter
            location = /Users/AuthenticateByName {
                # Use content phase to modify body and make HTTP request directly
                content_by_lua_block {
                    local http = require "resty.http"
                    local httpc = http.new()
                    
                    -- Read original request body
                    ngx.req.read_body()
                    local body = ngx.req.get_body_data()
                    local body_to_send = body
                    
                    if body and ngx.var.request_method == "POST" then
                        ngx.log(ngx.ERR, "[JELLYFIN-FIX] Original body: " .. body)
                        local cjson = require "cjson"
                        local ok, json = pcall(cjson.decode, body)
                        
                        if ok and json then
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] JSON parsed, App=" .. tostring(json.App) .. ", Username=" .. tostring(json.Username))
                            -- Inject App parameter if missing or empty
                            if not json.App or json.App == "" then
                                json.App = "Apple TV"
                                body_to_send = cjson.encode(json)
                                ngx.log(ngx.ERR, "[JELLYFIN-FIX] Injected App=Apple TV, new body: " .. body_to_send)
                            end
                        else
                            ngx.log(ngx.ERR, "[JELLYFIN-FIX] Failed to parse JSON")
                        end
                    end
                    
                    -- Prepare headers
                    local headers = {}
                    for k, v in pairs(ngx.req.get_headers()) do
                        if k ~= "content-length" and k ~= "host" then
                            headers[k] = v
                        end
                    end
                    headers["Content-Type"] = "application/json"
                    headers["Content-Length"] = string.len(body_to_send or "")
                    headers["Host"] = ngx.var.host
                    headers["X-Real-IP"] = ngx.var.remote_addr
                    headers["X-Forwarded-For"] = ngx.var.proxy_add_x_forwarded_for or ngx.var.remote_addr
                    headers["X-Forwarded-Proto"] = ngx.var.scheme
                    headers["X-Forwarded-Host"] = ngx.var.host
                    headers["X-Forwarded-Port"] = ngx.var.server_port
                    
                    -- Make HTTP request to Jellyfin
                    local res, err = httpc:request_uri("http://127.0.0.1:8096/Users/AuthenticateByName", {
                        method = ngx.var.request_method,
                        headers = headers,
                        body = body_to_send,
                    })
                    
                    if not res then
                        ngx.log(ngx.ERR, "[JELLYFIN-FIX] Failed to request: " .. tostring(err))
                        ngx.status = 500
                        ngx.say("Internal Server Error")
                        return
                    end
                    
                    -- Forward response
                    ngx.status = res.status
                    for k, v in pairs(res.headers) do
                        if k ~= "content-length" then
                            ngx.header[k] = v
                        end
                    end
                    if res.body then
                        ngx.header["Content-Length"] = string.len(res.body)
                        ngx.say(res.body)
                    end
                }
            }
        }
    }

